{% extends "head.html" %}

{% block head %}
<style media="screen" type="text/css">
.inputfile {
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
    cursor: pointer;
}

.pulse {
    animation-name: pulser;
    animation-duration: 2s;
    animation-iteration-count: infinite;
}
@keyframes pulser {
    0%, 100% {opacity: 0.1;}
    50% {opacity: 1.0;}
}

#content {
    top: 50%;
    left: 50%;
    position: absolute;
    transform: translate(-50%, -50%);
}

#folder {
    cursor: pointer;
    fill: rgba(0,0,0,0.4);
    transition: fill 0.5s ease;
}

#folder:hover {
    transition: fill 0.5s ease;
    fill: rgba(0,0,0,0.6);
}

.drag {fill: rgba(0,0,0,0.6);}
.hidden {display: none !important;}

#upload {
    text-decoration: none;
    text-align: center;
    cursor: pointer;
    background-color: rgba(0,0,0,0.4);
    font-size: 26px;
    border: none;
    color: white;
    padding: 10px 20px;
}

#backer {
    display: inline-block;
    background-color: rgba(0,0,0,0.4);
    margin-top: 10px;
}

#countlbl {
    color: white;
    font-weight: bold;
    font-size: 18px;
    padding-left: 12px;
    text-align: center;
    height: 45px;
    line-height: 45px;
}

#num {
    transform: translate(0, 2px);
    padding: 0;
    height: 45px;
    width: 45px;
    text-align: center;
    font-size: 24px;
    background-color: rgba(0,0,0,0.0);
    border: none;
    color: white;
    margin: 0;
}

#codeurl {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 256px; 
    margin: 0;
    padding: 0;
}
</style>

<script type='text/javascript'>
var tests, fld, lbl;
var busy = false;

function setlbl(val) {lbl.value = lbl.innerHTML = val;}

window.onload = function(){
    bdy = document.body;
    fld = document.getElementById('folder');
    lbl = document.getElementById('codeurl');

    tests = {
        filereader: typeof FileReader != 'undefined',
        dnd: 'draggable' in document.createElement('span'),
        formdata: !!window.FormData,
        progress: "upload" in new XMLHttpRequest
    }; 

    if (tests.dnd) { 
        bdy.ondragover = function() {if (!busy) {fld.classList = ['drag'];} return false;};
        bdy.ondragend = function() {if (!busy) {fld.classList = [''];} return false;};
        bdy.ondrop = function(e) {
            e.preventDefault();
            readfiles(e.dataTransfer.files);
        }
    }

    document.getElementById('filearg').onchange = function(){readfiles(this.files);};
}

function readfiles(files) {
    if (files.length == 0 || busy)
        return;

    var formData = tests.formdata ? new FormData() : null;
    for (var i=0; i<files.length; i++) {
        if (tests.formdata)
            formData.append('file', files[i]);
    }

    if (tests.formdata) {
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                document.getElementById('content').className = 'hidden';
                setlbl(xhr.responseText);
                lbl.className = 'border';
                busy = false;
            }
            if (xhr.readyState == XMLHttpRequest.OPENED) {
                document.getElementById('content').className = '';
                document.getElementById('upload').className = 'hidden';
                document.getElementById('backer').className = 'hidden';
                fld.classList = ['pulse'];
                lbl.className = '';
                setlbl('0%');
                busy = true;
            }
        }

        if (tests.progress) {
            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    var complete = Math.floor(100*(event.loaded / event.total));
                    setlbl(complete+'%');
                }
            }
        }

        xhr.open('POST', '/?codeonly=true');
        xhr.send(formData);
    }
}
</script>
{% end %}

{% block content %}
<br/>
<div id='content' class=''>
<center>
<form enctype="multipart/form-data" action='/' method='post' id='form'>
    <input type='file' id='filearg' name='filearg' class='inputfile'/><br/>
    <label for='filearg'>
        <svg id='folder' width="512" height="512" viewBox="0 0 256 256">
        <g transform="scale(0.25 0.25)">
            <path d="M576 256l-128-128h-448v832h1024v-704h-448zM512 480l224 224h-160v256h-128v-256h-160l224-224z"></path>
        </g>
    </svg><span></span>
    </label>
    <br/><input id='upload' type='submit' value='Upload'>
    <br/>
    <div id='backer'>
        <label for='n' id='countlbl'>COUNT: </label>
        <input type='text' name='n' id='num' value=1>
    </div>
</form>
</center>
</div>
<pre id='codeurl' class='hidden'></pre>
{% end %}
